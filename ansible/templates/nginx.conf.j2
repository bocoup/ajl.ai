upstream api {
  server localhost:{{env_vars[env].HTTP_PORT}};
}
{% for domain in [fqdn] + alias_domains %}

server {
  server_name {{domain}};
{% if env == 'development' %}
  listen 80;
{% endif %}
  listen 443 ssl;
  ssl_certificate_key {{cert_path}}/{{domain}}/{{ssl_key_file}};
  ssl_certificate {{cert_path}}/{{domain}}/{{ssl_cert_file}};
  root {{public_path}};
  index index.html;
  location / {
    try_files $uri /index.html;
{% if basic_auth %}
    auth_basic 'Image Annotator';
    auth_basic_user_file htpasswd;
{% endif %}
  }
{% if env != 'development' %}
  location /.well-known/acme-challenge {
    alias {{base_path}}/dehydrated;
  }
{% endif %}
  location /api {
    include proxy_params;
    proxy_pass http://api;
  }
  location ~* \.(css|js) {
    expires max;
    break;
  }
  gzip on;
  gzip_vary on;
  gzip_disable "MSIE [1-6]\.";
  gzip_comp_level 6;
  gzip_min_length 1100;
  gzip_buffers 16 8k;
  gzip_proxied any;
  gzip_proxied expired no-cache no-store private auth;
  gzip_types
      text/plain
      text/css
      text/js
      text/xml
      text/javascript
      application/javascript
      application/x-javascript
      application/json
      application/xml
      application/rss+xml
      image/svg+xml;
}
{% if env != 'development' %}

server {
  server_name {{domain}};
  listen 80;
  return 301 https://{{fqdn}}$request_uri;
}
{% endif %}
{% endfor %}
